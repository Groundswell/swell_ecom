

.container-fluid
	.row
		.col-xs-10
			%ul.breadcrumb
				%li
					%a{ href: order_admin_index_path }
						%i.fa.fa-angle-left
						Orders
			%h2
				%strong= @order.code
				%small=current_user.to_local_tz(@order.created_at).to_s( :short )

		.col-xs-2


	= form_for @order, url: order_admin_path( @order ) do |f|
		.row
			.col-xs-8
				.well.white-well

					%h4
						Order Details
						%small
							- if @order.fulfilled_at.present?
								.badge{ class: 'fulfilled', title: current_user.to_local_tz(@order.fulfilled_at).to_s( :short ) }
									%i.fa.fa-circle
									fulfilled
							- else
								.badge{ class: 'unfulfilled' }
									%i.fa.fa-circle-o
									unfulfilled

					%table.table.table-light.table-bordered{ style: 'margin: 0' }
						%thead
							%tr
								%th Product
								%th{ style: 'width: 80px' } Price
								%th.text-right{ style: 'width: 70px' } Quantity
								%th.text-right{ style: 'width: 100px' } Subtotal
						%tbody
							- @order.order_items.prod.each do |order_item|
								%tr
									%td
										- if order_item.subscription.present?
											%a{ href: edit_subscription_admin_path( order_item.subscription ) }
												= order_item.title
												(#{order_item.subscription.code})
										- else
											= order_item.title

									%td
										= number_to_currency (order_item.price.to_f / 100)
									%td.text-right
										=order_item.quantity
									%td.text-right= number_to_currency order_item.subtotal.to_f / 100

							%tr
								%td
								%td
								%td
									Subtotal
								%td.text-right
									%strong
										= number_to_currency @order.subtotal.to_f / 100

							%tr
								%td
								%td
								%td
									Tax
								%td.text-right
									%strong
										= number_to_currency @order.tax.to_f / 100
							%tr
								%td
								%td
								%td
									Shipping
								%td.text-right
									%strong
										= number_to_currency @order.shipping.to_f / 100
							%tr
								%td
								%td
								%td
									%h5{ style: 'font-weight:bold;' }
										Total
								%td.text-right
									%h5{ style: 'font-weight:bold;' }
										= number_to_currency ( @order.total || 0 ).to_f / 100

					.row
						.col-xs-8
							%h4
								Customer Notes
							.well
								= raw @order.customer_notes || 'N/A'

						.col-xs-4
							- if ( refund_amount = @transactions.approved.negative.to_a.sum(&:signed_amount) ) != 0
								%table.table.table-light.table-bordered{ style: 'margin:0;' }
									%tbody
										%tr
											%td
												%h5{ style: 'font-weight:bold;' }
													Paid by Customer
											%td.text-right{ style: 'width: 100px' }
												%h5{ style: 'font-weight:bold;' }
													= number_to_currency ( @transactions.approved.positive.to_a.sum(&:signed_amount) / 100.0 )
										%tr
											%td
												%h5{ style: 'font-weight:bold;' }
													Refunded Amount
											%td.text-right
												%h5{ style: 'font-weight:bold;' }
													= number_to_currency ( refund_amount / 100.0 )
										%tr
											%td
												%h5{ style: 'font-weight:bold;' }
													Net
											%td.text-right
												%h5{ style: 'font-weight:bold;' }
													= number_to_currency ( @transactions.approved.to_a.sum(&:signed_amount) / 100.0 )
							- else
								%table.table.table-light.table-bordered
									%tbody
										%tr
											%td
												%h5{ style: 'font-weight:bold;' }
													Paid by Customer
											%td.text-right{ style: 'width: 100px' }
												%h5{ style: 'font-weight:bold;' }
													= number_to_currency ( @transactions.approved.positive.to_a.sum(&:signed_amount) / 100.0 )
								.text-center
									%a.btn.btn-success{ data: { toggle: :modal, target: '#refund_order' } }
										%i.fa.fa-plus-square
										Refund
				.well.white-well

					.pull-right
						%a{ href: '#', data: { toggle: :modal, target: '#edit_support_notes_order' } }
							Edit
					%h4
						Support Notes
					=@order.support_notes || 'N/A'

				.well.white-well
					%h4 Transactions
					%table.table.table-light.table-bordered{ style: 'margin: 0;' }
						%thead
							%tr
								%th{ style: 'width: 10em' } Type
								%th{ style: 'width: 10em' } Status
								%th{ style: 'width: 10em' } Gateway
								%th Reference
								%th.text-right{ style: 'width: 10em' } Amount
								%th{ style: 'width: 4em' } Currency
						%tbody
							- @transactions.each do |transaction|
								%tr
									%td
										= transaction.transaction_type
									%td
										= transaction.status
									%td
										= transaction.provider
									%td
										= transaction.reference_code
									%td.text-right
										= number_to_currency (transaction.amount.to_f / 100)
									%td
										= transaction.currency


			.col-xs-4
				.well.white-well
					%h5
						Status
					.form-group
						= f.collection_select :status, SwellEcom::Order.statuses, :first, :first, {}, class: 'form-control'

					.form-group
						= f.submit 'Update', class: 'btn btn-primary'

				- if @order.user.present?
					.well.white-well
						.pull-right
							%a{ href: edit_customer_admin_path( @order.user ) }
								Edit
						%h5
							Customer
						%div
							%a{ href: edit_customer_admin_path( @order.user ) }= @order.user.full_name
						%a{ href: edit_customer_admin_path( @order.user ) }= @order.user.email

				.well.white-well
					.pull-right
						%a{ href: '#', data: { toggle: :modal, target: '#billing_address_modal' } } Edit
					%h5
						Billing Address
					= raw @order.billing_address.to_html


				.well.white-well
					.pull-right
						%a{ href: '#', data: { toggle: :modal, target: '#shipping_address_modal' } } Edit
					%h5
						Shipping Address
					= raw @order.shipping_address.to_html


= render 'swell_ecom/order_admin/refund_modal'
= render 'swell_ecom/order_admin/support_notes_modal'
= render 'swell_ecom/order_admin/edit_address_modal', args: { title: 'Shipping Address', attribute: 'shipping_address' }
= render 'swell_ecom/order_admin/edit_address_modal', args: { title: 'Billing Address', attribute: 'billing_address' }
